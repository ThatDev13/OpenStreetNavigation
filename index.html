<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenStreetNavigation</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#f3f4f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzNiODJmNiIvPjxwYXRoIGQ9Ik0yNTYgMTI4Yy01MyAwLTk2IDQzLTk2IDk2IDAgNTMgOTYgMTkyIDk2IDE5MnM5Ni0xMzkgOTYtMTkyYzAtNTMtNDMtOTYtOTYtOTZ6bTAgMTI4Yy0xNy43IDAtMzItMTQuMy0zMi0zMnMxNC4zLTMyIDMyLTMyIDMyIDE0LjMgMzIgMzItMTQuMyAzMi0zMiAzMnoiIGZpbGw9IndoaXRlIi8+PC9zdmc+">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzNiODJmNiIvPjxwYXRoIGQ9Ik0yNTYgMTI4Yy01MyAwLTk2IDQzLTk2IDk2IDAgNTMgOTYgMTkyIDk2IDE5MnM5Ni0xMzkgOTYtMTkyYzAtNTMtNDMtOTYtOTYtOTZ6bTAgMTI4Yy0xNy43IDAtMzItMTQuMy0zMi0zMnMxNC4zLTMyIDMyLTMyIDMyIDE0LjMgMzIgMzItMTQuMyAzMi0zMiAzMnoiIGZpbGw9IndoaXRlIi8+PC9zdmc+">
    <link rel="manifest" href='data:application/manifest+json;utf8,{"name":"OpenStreetNavigation","short_name":"OSNav","start_url":".","display":"standalone","background_color":"#f3f4f6","theme_color":"#f3f4f6","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzNiODJmNiIvPjxwYXRoIGQ9Ik0yNTYgMTI4Yy01MyAwLTk2IDQzLTk2IDk2IDAgNTMgOTYgMTkyIDk2IDE5MnM5Ni0xMzkgOTYtMTkyYzAtNTMtNDMtOTYtOTYtOTZ6bTAgMTI4Yy0xNy43IDAtMzItMTQuMy0zMi0zMnMxNC4zLTMyIDMyLTMyIDMyIDE0LjMgMzIgMzItMTQuMyAzMi0zMiAzMnoiIGZpbGw9IndoaXRlIi8+PC9zdmc+","sizes":"512x512","type":"image/svg+xml"}]}'>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior: none;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Hide Leaflet Routing Machine default container */
        .leaflet-routing-container { display: none !important; }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Map height */
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 0;
        }

        /* User Marker Pulse */
        .user-pulse {
            background: rgba(59, 130, 246, 0.4);
            border-radius: 50%;
            height: 100%;
            width: 100%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        /* Navigation Arrow */
        .nav-arrow {
            width: 0; 
            height: 0; 
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #3b82f6;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body class="overflow-hidden bg-gray-100">

    <!-- Navigation Overlay (Top) - Hidden by default -->
    <div id="nav-overlay" class="hidden fixed top-0 left-0 w-full z-[2000] pointer-events-none p-4 pt-12 md:pt-4 flex justify-center">
        <div class="bg-[#1c1c1e] text-white p-4 rounded-2xl shadow-2xl pointer-events-auto flex items-center gap-5 w-full max-w-lg border border-gray-700/50">
            <div id="nav-icon" class="text-5xl font-bold text-green-400">↑</div>
            <div class="flex-1 min-w-0">
                <div id="nav-dist" class="text-3xl font-bold tracking-tight">0 m</div>
                <div id="nav-instruction" class="text-xl font-medium text-gray-300 truncate">Route wird berechnet...</div>
            </div>
        </div>
    </div>

    <!-- Main Control Panel -->
    <div id="main-panel" class="fixed z-[1000] w-[92%] max-w-md left-1/2 -translate-x-1/2 bottom-6 md:translate-x-0 md:left-4 md:top-4 md:bottom-auto md:w-96 flex flex-col gap-3 transition-all duration-500 ease-in-out">
        
        <!-- Search & Mode Card -->
        <div id="search-card" class="glass rounded-3xl shadow-2xl shadow-black/10 p-5 text-gray-800 transition-transform duration-300">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-lg font-bold text-gray-900">OpenStreetNavigation</h1>
                <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
            </div>
            
            <!-- Travel Modes (No ÖVM) -->
            <div class="flex bg-gray-100 p-1 rounded-xl mb-4">
                <button onclick="setMode('car')" id="btn-car" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600">
                    Auto
                </button>
                <button onclick="setMode('foot')" id="btn-foot" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:bg-gray-200/50">
                    Zu Fuß
                </button>
                <button onclick="setMode('bike')" id="btn-bike" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:bg-gray-200/50">
                    Rad
                </button>
            </div>

            <!-- Inputs -->
            <div class="bg-gray-50/80 rounded-2xl border border-gray-100 overflow-hidden">
                <div class="flex items-center gap-3 px-3 py-2 border-b border-gray-100">
                    <div class="w-2 h-2 rounded-full bg-blue-500 shrink-0 ml-1"></div>
                    <input type="text" id="start-input" placeholder="Mein Standort" class="w-full bg-transparent border-0 py-1 text-base outline-none placeholder-gray-400 text-gray-800">
                </div>
                <div class="flex items-center gap-3 px-3 py-2">
                    <div class="w-2 h-2 rounded-full bg-red-500 shrink-0 ml-1"></div>
                    <input type="text" id="end-input" placeholder="Ziel suchen..." class="w-full bg-transparent border-0 py-1 text-base outline-none placeholder-gray-400 text-gray-800">
                </div>
            </div>
            
            <button onclick="calculateRoute()" id="btn-route" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white font-bold py-3.5 rounded-2xl transition-all shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 text-base">
                Route suchen
            </button>
        </div>

        <!-- Directions Summary (Initially Hidden) -->
        <div id="directions-panel" class="hidden glass rounded-3xl shadow-2xl shadow-black/10 overflow-hidden max-h-[50vh] flex flex-col transition-all">
            <div class="p-4 bg-white/40 backdrop-blur-md border-b border-white/20">
                <div class="flex justify-between items-end mb-2">
                    <div id="route-time" class="text-3xl font-bold text-gray-900 tracking-tight leading-none">0 min</div>
                    <div id="route-dist" class="text-sm font-medium text-gray-500 mb-1">0 km</div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="startNavigation()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg shadow-green-500/20 active:scale-95 transition-all">
                        Starten
                    </button>
                    <button onclick="cancelRoute()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition-colors">
                        ✕
                    </button>
                </div>
            </div>
            <div id="instructions-list" class="overflow-y-auto p-2 space-y-1 bg-white/30 backdrop-blur-sm">
                <!-- Instructions will be injected here -->
            </div>
        </div>
    </div>

    <!-- Stop Navigation Button (Hidden) -->
    <div id="nav-footer" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 z-[2000] pointer-events-auto">
        <button onclick="stopNavigation()" class="bg-red-500/90 backdrop-blur-md hover:bg-red-600 text-white px-8 py-4 rounded-full font-bold shadow-xl text-xl flex items-center gap-2 active:scale-95 transition-all">
            <span class="text-2xl">✕</span> Beenden
        </button>
    </div>



    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[3000] flex items-center justify-center bg-black/20 backdrop-blur-sm p-4 transition-all">
        <div class="glass bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm relative transform scale-100 opacity-100 transition-all">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center font-bold">✕</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Einstellungen</h2>
            
            <div class="space-y-4">
                <div>
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Version</div>
                    <div class="text-lg font-medium text-gray-900">v26.0</div>
                </div>
                
                <div>
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Patchnotes</div>
                    <ul class="text-sm text-gray-600 mt-1 list-disc list-inside space-y-1">
                        <li>Deutsche Sprachausgabe hinzugefügt</li>
                        <li>Navigation UI verbessert</li>

                        <li>Performance Optimierungen</li>
                    </ul>
                </div>

                <div>
                     <a href="https://github.com/ThatDev13/OpenStreetNavigation" target="_blank" class="flex items-center justify-center gap-2 w-full bg-[#24292e] text-white py-3 rounded-xl font-bold hover:bg-[#1b1f23] transition-colors shadow-lg active:scale-95">
                        <svg height="20" width="20" viewBox="0 0 16 16" fill="white"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                        GitHub
                    </a>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <p class="text-xs text-center text-gray-400 font-medium">
                        No © 2026 Appic Applications<br>
                        <span class="opacity-75">ein Space Games International-Team</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- State ---
        let map;
        let routingControl;
        let currentMode = 'car';
        let userMarker = null;
        let userLocation = null;
        let isNavigating = false;
        let currentRoute = null;
        let watchId = null;

        // --- Icons ---
        const userIcon = L.divIcon({
            className: 'bg-transparent',
            html: `<div class="relative w-6 h-6">
                     <div class="absolute inset-0 bg-blue-500 rounded-full border-[3px] border-white shadow-lg z-10"></div>
                     <div class="absolute -inset-4 user-pulse z-0"></div>
                   </div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        const navIcon = L.divIcon({
            className: 'bg-transparent',
            html: `<div style="transform: translate(-50%, -50%);" class="w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[24px] border-b-blue-600 drop-shadow-md"></div>`,
            iconSize: [0, 0] // Centered via html transform
        });

        // --- Init ---
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([52.5200, 13.4050], 13);

            L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            // User Location Watcher
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(updateUserLocation, handleLocationError, {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 10000
                });
            }

            // Map Click (Set Destination) - Disabled
            /*
            map.on('click', async function(e) {
               // Disabled per user request
            });
            */
        }

        // --- Location Logic ---
        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = L.latLng(lat, lng);

            if (!userMarker) {
                userMarker = L.marker(userLocation, {icon: userIcon}).addTo(map);
                map.setView(userLocation, 15);
            } else {
                userMarker.setLatLng(userLocation);
            }

            // If navigating, center map and update instructions
            if (isNavigating) {
                map.panTo(userLocation);
                updateNavigationState(userLocation);
            }
        }

        function handleLocationError(error) {
            console.warn("Location Error: " + error.message);
        }

        // --- Mode Switching ---
        function setMode(mode) {
            currentMode = mode;
            ['car', 'foot', 'bike'].forEach(m => {
                const btn = document.getElementById('btn-' + m);
                if (m === mode) {
                    btn.className = "flex-1 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600";
                } else {
                    btn.className = "flex-1 py-2 rounded-lg text-sm font-semibold transition-all text-gray-500 hover:bg-gray-200/50";
                }
            });
            // Recalculate if possible
            if (document.getElementById('end-input').value) {
                // If route is already displayed, refresh it
                if (document.getElementById('directions-panel').classList.contains('hidden') === false) {
                    calculateRoute();
                }
            }
        }

        // --- Routing ---
        async function geocode(query) {
            if (!query) return null;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();
                if (data && data.length > 0) return L.latLng(data[0].lat, data[0].lon);
            } catch (e) { console.error(e); }
            return null;
        }

        async function calculateRoute() {
            const startVal = document.getElementById('start-input').value;
            const endVal = document.getElementById('end-input').value;
            const btn = document.getElementById('btn-route');
            
            if (!endVal) {
                alert("Bitte ein Ziel eingeben oder auf die Karte tippen.");
                return;
            }

            // Loading state
            const oldBtnText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-spin text-xl">↻</span> Lade Route...';
            btn.disabled = true;

            try {
                let startLatLng = userLocation;

                // If user typed a start location manually (not empty and not "Mein Standort")
                if (startVal && startVal.toLowerCase() !== "mein standort") {
                    startLatLng = await geocode(startVal);
                } else if (!userLocation) {
                    // Try to get one-off location if watch hasn't fired yet
                     try {
                        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
                        startLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
                        updateUserLocation(pos);
                    } catch (e) {
                        alert("Standort nicht verfügbar. Bitte Startadresse eingeben.");
                        throw e;
                    }
                }

                const endLatLng = await geocode(endVal);

                if (!startLatLng || !endLatLng) throw new Error("Ort nicht gefunden");

                // Cleanup
                if (routingControl) map.removeControl(routingControl);
                if (window.tempMarker) map.removeLayer(window.tempMarker);
                window.tempMarker = null;

                // Setup OSRM profile
                let profile = 'driving';
                if (currentMode === 'foot') profile = 'walking';
                if (currentMode === 'bike') profile = 'cycling';

                routingControl = L.Routing.control({
                    waypoints: [startLatLng, endLatLng],
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: profile,
                        language: 'de'
                    }),
                    lineOptions: {
                        styles: [{color: '#3b82f6', opacity: 0.7, weight: 7}]
                    },
                    createMarker: function(i, wp) {
                        // Start marker is hidden (we use user location), End marker is Red
                        if (i === 0) return null; 
                        return L.marker(wp.latLng, {
                            icon: L.divIcon({
                                className: 'bg-transparent',
                                html: '<div class="w-6 h-6 rounded-full bg-red-600 border-4 border-white shadow-lg"></div>',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        });
                    },
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: true,
                    showAlternatives: false
                })
                .on('routesfound', function(e) {
                    currentRoute = e.routes[0];
                    showRouteSummary(currentRoute);
                    btn.innerHTML = oldBtnText;
                    btn.disabled = false;
                })
                .on('routingerror', function() {
                    alert("Route konnte nicht berechnet werden.");
                    btn.innerHTML = oldBtnText;
                    btn.disabled = false;
                })
                .addTo(map);

            } catch (e) {
                console.error(e);
                btn.innerHTML = oldBtnText;
                btn.disabled = false;
            }
        }

        function showRouteSummary(route) {
            document.getElementById('search-card').classList.add('hidden');
            document.getElementById('directions-panel').classList.remove('hidden');
            
            const summary = route.summary;
            const totalMin = Math.round(summary.totalTime / 60);
            const h = Math.floor(totalMin / 60);
            const m = totalMin % 60;
            const timeStr = h > 0 ? `${h} h ${m} min` : `${m} min`;
            
            document.getElementById('route-time').innerText = timeStr;
            
            const distKm = (summary.totalDistance / 1000).toFixed(1);
            document.getElementById('route-dist').innerText = distKm + " km • " + (currentMode === 'car' ? 'Schnellste Route' : 'Route');
            
            // Populate list (preview)
            const list = document.getElementById('instructions-list');
            list.innerHTML = '';
            route.instructions.forEach(instr => {
                const div = document.createElement('div');
                div.className = "flex gap-3 p-3 border-b border-gray-100/50 last:border-0 items-center";
                div.innerHTML = `
                    <div class="font-bold text-gray-500 text-xl w-8 text-center">${getTurnIcon(instr.type, instr.modifier)}</div>
                    <div class="text-sm text-gray-800 leading-snug">
                        ${instr.text}
                        <div class="text-xs text-gray-400 mt-0.5">${formatDist(instr.distance)}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function cancelRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            currentRoute = null;
            document.getElementById('directions-panel').classList.add('hidden');
            document.getElementById('search-card').classList.remove('hidden');
            
            // Clear map clutter
            if (window.tempMarker) map.removeLayer(window.tempMarker);
            window.tempMarker = null;
        }

        // --- Navigation Mode ---
        function startNavigation() {
            if (!currentRoute) return;
            isNavigating = true;

            // UI Changes
            document.getElementById('main-panel').classList.add('translate-y-[150%]', 'opacity-0'); // Hide main panel
            document.getElementById('nav-overlay').classList.remove('hidden');
            document.getElementById('nav-footer').classList.remove('hidden');

            // Map Changes
            map.setZoom(18);
            if (userLocation) map.panTo(userLocation);
            
            // Speak first instruction
            if (currentRoute.instructions.length > 0) {
                speak(currentRoute.instructions[0].text);
                updateNavUI(currentRoute.instructions[0], 0);
            }
        }

        function stopNavigation() {
            isNavigating = false;
            
            // UI Changes
            document.getElementById('nav-overlay').classList.add('hidden');
            document.getElementById('nav-footer').classList.add('hidden');
            document.getElementById('main-panel').classList.remove('translate-y-[150%]', 'opacity-0');
            
            // Map Reset
            map.setZoom(13);
            if (currentRoute) {
                const bounds = L.latLngBounds(currentRoute.coordinates);
                map.fitBounds(bounds);
            }
        }

        function updateNavigationState(userLatLng) {
            // Find closest instruction
            if (!currentRoute) return;
            
            // Simple logic: Find the next instruction based on distance
            // In a real app, we would project position to the route line.
            
            // For this demo, we just display the first instruction that is somewhat ahead
            // This is a simplified "Navigation" logic
            
            // We can calculate distance to the *next* maneuver point.
            // Let's assume the user is following the route.
            
            // Find closest coordinate index on route
            let minDist = Infinity;
            let closestIndex = 0;
            const path = currentRoute.coordinates;
            
            for(let i=0; i<path.length; i++) {
                const d = userLatLng.distanceTo(path[i]);
                if(d < minDist) {
                    minDist = d;
                    closestIndex = i;
                }
            }
            
            // Find which instruction corresponds to this index
            // instructions have an 'index' property which refers to the coordinate index
            const instrs = currentRoute.instructions;
            let currentInstrIdx = 0;
            
            for(let i=0; i<instrs.length; i++) {
                if (instrs[i].index > closestIndex) {
                    break;
                }
                currentInstrIdx = i;
            }
            
            // The "next" instruction is usually current + 1 if we are *on* the segment
            // But usually the instruction text describes what to do at the END of the segment.
            // So if we are in segment 0, instruction 0 tells us what to do at the end of segment 0.
            
            const activeInstr = instrs[currentInstrIdx];
            if (activeInstr) {
                // Calculate distance from user to the maneuver point
                const maneuverLatLng = path[activeInstr.index];
                const distanceToManeuver = userLatLng.distanceTo(maneuverLatLng);
                
                updateNavUI(activeInstr, distanceToManeuver);

                // Voice announcement logic (simplified)
                if (distanceToManeuver < 100 && !activeInstr.announced) {
                    speak("In 100 Metern " + activeInstr.text);
                    activeInstr.announced = true;
                }
            }
        }

        function updateNavUI(instr, dist) {
            document.getElementById('nav-instruction').innerText = instr.text;
            document.getElementById('nav-dist').innerText = formatDist(dist);
            
            let icon = '↑';
            if (instr.type === 'TurnRight') icon = '↱';
            if (instr.type === 'TurnLeft') icon = '';
            if (instr.type === 'Roundabout') icon = '↻';
            if (instr.type === 'DestinationReached') icon = '★';
            
            document.getElementById('nav-icon').innerText = icon;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'de-DE';
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- Helpers ---
        function formatDist(d) {
            if (d >= 1000) return (d/1000).toFixed(1) + " km";
            return Math.round(d) + " m";
        }
        
        function getTurnIcon(type, modifier) {
             // Simplified icon mapping
             if (type === 'Straight') return '↑';
             if (type.includes('Right')) return '→';
             if (type.includes('Left')) return '←';
             if (type === 'DestinationReached') return '★';
             return '•';
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
        }

        // --- Key Listeners ---
        document.getElementById('end-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') calculateRoute();
        });

        // Start
        window.addEventListener('DOMContentLoaded', initMap);

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'osnav-v1';
                self.addEventListener('install', (e) => self.skipWaiting());
                self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
                self.addEventListener('fetch', (e) => {
                    // Network only for maps, but handle basic offline
                    e.respondWith(
                        fetch(e.request).catch(() => new Response("Offline"))
                    );
                });
            `;
            const blob = new Blob([swContent], {type: 'application/javascript'});
            const url = URL.createObjectURL(blob);
            navigator.serviceWorker.register(url)
                .then(() => console.log('SW Registered'))
                .catch(err => console.error('SW Fail', err));
        }

    </script>
</body>
</html>
